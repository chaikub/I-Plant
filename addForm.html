<!DOCTYPE html>
<html>

<head>
  <title>Add Crosswalk Page</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-firestore.js"></script>
  <style>
    body {
      height: 100vh;
      width: 100%;
    }

    #map {
      height: 600px;
      width: 100%;
    }

    #search {
      width: 500px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div class="p-5">
    <h2>Add Crosswalk Form</h2>
    <div class="input-group">
      <input type="search" id="search" class="form-control rounded" placeholder="Search" aria-label="Search"
        aria-describedby="search-addon" />
    </div>
    <div id="map"></div>
    <div class="mt-3">
        <label>Description : </label>
        <textarea class="form-control" id="textarea" rows="3"></textarea>
    </div>
    <div class="mt-3">
        <button type="button" class="btn btn-primary" onclick="addCrosswalk()">Submit</button>
    </div>
  </div>
</body>

<script>
    var map;
    var marker;
    var markers = [];
    var lat = 0;
    var lng = 0;

    const firebaseConfig = {
        apiKey: "AIzaSyD5ydz7UfbheMOnuWsAnGdZACAs7GSaE8w",
        authDomain: "dev-tool-383706.firebaseapp.com",
        projectId: "dev-tool-383706",
        storageBucket: "dev-tool-383706.appspot.com",
        messagingSenderId: "247600650475",
        appId: "1:247600650475:web:76a232ef25ccc5345d46ae",
        measurementId: "G-QN5Q2ZZSED"
    };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  
  // Get data from Firebase
  var db = firebase.firestore();

  function addCrosswalk(){
    var desc = document.getElementById("textarea").value;
    console.log(desc);
    if(lat == 0 || lng == 0 || desc == ""){
        return false;
    }
    // Add a new document with a generated ID
    db.collection("location").add({
        lat: lat,
        long: lng,
        desc: document.getElementById("textarea").value,
    })
    .then((docRef) => {
        console.log("Document written with ID: ", docRef.id);
    })
    .catch((error) => {
        console.error("Error adding document: ", error);
    });
  }

  function initMap() {
    // Create a new map centered on San Francisco
    var map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 37.7749, lng: -122.4194 },
      zoom: 12
    });

    
    db.collection("location").get().then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        var data = doc.data();
        console.log(data);
        var marker = new google.maps.Marker({
          position: {lat: data.lat, lng: data.long},
          map: map,
          title: data.desc,
          icon: {
            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            scaledSize: new google.maps.Size(32, 32)
          }
        });
        markers.push(marker);
      });
    }).catch((error) => {
      console.log("Error getting documents: ", error);
    });

    map.addListener('click', function(event) {
        // Get the latitude and longitude values of the clicked location
        lat = event.latLng.lat();
        lng = event.latLng.lng();

        console.log(lat, lng);

        // Add a marker to the last clicked position
        if (marker) {
            marker.setMap(null); // Remove the old marker
        }

        marker = new google.maps.Marker({
            position: {lat: lat, lng: lng},
            map: map,
            icon: {
              url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
              scaledSize: new google.maps.Size(32, 32)
            }
        });
    });

    // Create the search box and link it to the UI element
    var input = document.getElementById('search');
    var searchBox = new google.maps.places.SearchBox(input);

    // Bias the search box results towards the current map's viewport
    map.addListener('bounds_changed', function () {
      searchBox.setBounds(map.getBounds());
    });

    // Listen for the event fired when the user selects a prediction and retrieve
    // more details for that place
    searchBox.addListener('places_changed', function () {
      var places = searchBox.getPlaces();

      if (places.length == 0) {
        return;
      }

      // Clear out any existing markers on the map
      markers.forEach(function (marker) {
        marker.setMap(null);
      });
      markers = [];

      // For each place, get the icon, name and location
      var bounds = new google.maps.LatLngBounds();
      places.forEach(function (place) {
        if (!place.geometry) {
          console.log("Returned place contains no geometry");
          return;
        }

        var icon = {
          url: place.icon,
          size: new google.maps.Size(71, 71),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(17, 34),
          scaledSize: new google.maps.Size(25, 25)
        };

        // Create a marker for each place
        var marker = new google.maps.Marker({
          map: map,
          title: place.name,
          position: place.geometry.location
        });

        markers.push(marker);

        if (place.geometry.viewport) {
          // Only geocodes have viewport
          bounds.union(place.geometry.viewport);
        } else {
          bounds.extend(place.geometry.location);
        }
      });

      map.fitBounds(bounds);
    });

    // Try HTML5 geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        // Add a marker at the user's current location
        var marker = new google.maps.Marker({
          position: pos,
          map: map,
          title: 'Your Location'
        });

        // Center the map on the user's current location
        map.setCenter(pos);
      }, function () {
        // If the geolocation request fails, default to San Francisco
        handleLocationError(true, map.getCenter());
      });
    } else {
      // If the user's browser doesn't support geolocation, default to San Francisco
      handleLocationError(false, map.getCenter());
    }
  }

  function handleLocationError(browserHasGeolocation, pos) {
    var infoWindow = new google.maps.InfoWindow({ map: map });
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
      'Error: The Geolocation service failed.' :
      'Error: Your browser doesn\'t support geolocation.');
  }

  var markers = [];

</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJshDbvcJY0XX-8r0shEi0B8kUj8Ha7v0&libraries=places&callback=initMap" async defer>
</script>

<script type="module" src="./app.js">
    console.log(data);
</script>

</html>